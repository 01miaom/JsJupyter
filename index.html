<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>JsJupyter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/theme/material.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.2/mode/javascript/javascript.min.js">
    </script>
    <link rel="stylesheet" href="https://www.canvasxpress.org/dist/canvasXpress.css"type="text/css"/>
 <script type="text/javascript"src="https://www.canvasxpress.org/dist/canvasXpress.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
  </head>
  <body>
      <h2>JsJupyter</h2>
    <section>
    <input id="file-upload" type="file">
    <canvas id="canvas" width="0" height="0"></canvas>
    <label id="upload-btn" for="file-upload"><i class="bi bi-upload"></i></label>
    <button id="download-btn"><i class="bi bi-save"></i></button>
    <button id="add-cell-btn"><i class="bi bi-plus-lg"></i> Code</button>
    <button id="add-cell-text-btn"><i class="bi bi-plus-lg"></i> Text</button>
    <button id="delete-cell-btn"><i class="bi bi-trash3"></i></button>
    <button id="run-cell-btn"><i class="bi bi-caret-right"></i></button>
    <button id="run-all-btn">Run All</button>
    </section>
    <section>
    <div id="notebook"></div>
    </section>
    <script>
      let currentCellIndex = 0;
      let cells = [
        { type: "text", content: "This is a text cell"},
        { type: "code", content: "console.log('Hello, World!')", output:"test" },
      ];

      const renderCell = (cell, index) => {
        const cellEl = document.createElement("div");
        cellEl.className = "block";
        cellEl.setAttribute("data-index", index);
          
        const cellCont = document.createElement("div");
        cellCont.className = "control";
        cellEl.append(cellCont);

        if (cell.type === "code") {
          const inputEl = document.createElement("div"); // 
          const codeMirrorInstance = CodeMirror(inputEl, { // 
                autoRefresh: true,
                value: cell.content,
                mode: "javascript",
                lineNumbers: false,
                viewportMargin: Infinity,
                //theme: "material",
            });
        //codeMirrorInstance.refresh();

            
        var tmp =function(){
            codeMirrorInstance.refresh();
        }

        setTimeout(tmp,50);
        
          inputEl.classList.add("input");
          inputEl.addEventListener("blur", () => {
            cell.content = codeMirrorInstance.value;//inputEl.value;
            console.log(codeMirrorInstance.value);
          });
          cellEl.appendChild(inputEl);
        
        //initial output
        let output = cell.output;
        const outputEl = document.createElement("div");
        outputEl.classList.add("output");
        outputEl.innerText = output;
        if(output != ""){
            cellEl.appendChild(outputEl);
        }

          const runBtn = document.createElement("button");
          const runi = document.createElement("i");
          runi.className = 'bi bi-caret-right';
          runBtn.appendChild(runi);
          //runBtn.innerText = "Run";
          runBtn.id = "runbtn";
            
          runBtn.addEventListener("click", () => {
            let output = "";
            const outputEl = document.createElement("div");
            outputEl.classList.add("output");
            try {
              //const output = eval(cell.content);
              const fn = new Function(cell.content);
              const log = console.log;
                console.log = function(message) {
                output += message + "\n";
                };
              fn();
              console.log = log;
              outputEl.innerText = output;//JSON.stringify(output);
              cell.output = output;
            } catch (err) {
              outputEl.innerText = err.message;
              cell.output = err.message;
            }
            const outputDiv = cellEl.querySelector(".output");
            if (outputDiv) {
                outputDiv.remove();
                cellEl.appendChild(outputEl);
            }
            else{
            cellEl.appendChild(outputEl);
            }
          });
          //cellEl.appendChild(runBtn);
        cellCont.insertBefore(runBtn, cellCont.firstChild);
            
            // Add event listener to update cells array when CodeMirror content changes
        codeMirrorInstance.on("change", () => {
          cell.content = codeMirrorInstance.getValue();
          cells[index] = cell;
        });
            
        } else if (cell.type === "text") {
          const inputEl = document.createElement("textarea");
          inputEl.value = cell.content;
          inputEl.classList.add("input");
          inputEl.addEventListener("blur", () => {
            cell.content = inputEl.value;
          });
          cellEl.appendChild(inputEl);
        }

        const deleteBtn = document.createElement("button");
        const deletei = document.createElement("i");
        deletei.className = 'bi bi-trash3';
        deleteBtn.appendChild(deletei);
        deleteBtn.addEventListener("click", () => {
          cells.splice(index, 1);
          renderNotebook();
        });
        //cellEl.appendChild(deleteBtn);
        cellCont.insertBefore(deleteBtn, cellCont.firstChild);


        const moveDownBtn = document.createElement("button");
        const moveDown = document.createElement("i");
        moveDown.className = 'bi bi-arrow-down';
        moveDownBtn.appendChild(moveDown);
        moveDownBtn.addEventListener("click", () => {
          if (index < cells.length - 1) {
            const temp = cells[index + 1];
            cells[index + 1] = cell;
            cells[index] = temp;
            renderNotebook();
          }
        });
        //cellEl.appendChild(moveDownBtn);
        cellCont.insertBefore(moveDownBtn, cellCont.firstChild);
        
        const moveUpBtn = document.createElement("button");
        const moveUp = document.createElement("i");
        moveUp.className = 'bi bi-arrow-up';
        moveUpBtn.appendChild(moveUp);
        moveUpBtn.addEventListener("click", () => {
          if (index > 0) {
            const temp = cells[index - 1];
            cells[index - 1] = cell;
            cells[index] = temp;
            renderNotebook();
          }
        });
        //cellEl.appendChild(moveUpBtn);
        cellCont.insertBefore(moveUpBtn, cellCont.firstChild);
        return cellEl;
      };

      const renderNotebook = () => {
        const notebookEl = document.getElementById("notebook");
        notebookEl.innerHTML = "";

        cells.forEach((cell, index) => {
        const cellEl = renderCell(cell, index);
         
        notebookEl.appendChild(cellEl);
    });
  };

  renderNotebook();

  const addCellBtn = document.getElementById("add-cell-btn");
  addCellBtn.addEventListener("click", () => {
  cells.splice(currentCellIndex + 1, 0, { type: "code", content: "", output: "" });
  currentCellIndex += 1;
  renderNotebook();
});

const addCellTextBtn = document.getElementById("add-cell-text-btn");
  addCellTextBtn.addEventListener("click", () => {
  cells.splice(currentCellIndex + 1, 0, { type: "text", content: "" });
  currentCellIndex += 1;
  renderNotebook();
});

const runCellBtn = document.getElementById("run-cell-btn");
runCellBtn.addEventListener("click", () => {
  const currentCellEl = document.querySelector(`[data-index="${currentCellIndex}"]`);
  const currentCellType = cells[currentCellIndex].type;
  if (currentCellType === "code") {
    const runBtn = currentCellEl.querySelectorAll("button");
    runBtn[3].click();
  }
  if (currentCellIndex < cells.length - 1) {
    currentCellIndex += 1;
    const nextCellEl = document.querySelector(`[data-index="${currentCellIndex}"]`);
    nextCellEl.scrollIntoView();
  }
});

const runAllBtn = document.getElementById("run-all-btn");
runAllBtn.addEventListener("click", () => {
  cells.forEach((cell, index) => {
    if (cell.type === "code") {
      const currentCellEl = document.querySelector(`[data-index="${index}"]`);
      const runBtn = currentCellEl.querySelectorAll("button");
      runBtn[3].click();
    }
  });
});
        
const downloadBtn = document.getElementById("download-btn");
downloadBtn.addEventListener("click", () => {
  const jsonString = JSON.stringify(cells);

  const blob = new Blob([jsonString], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = "JsJupyter.json";
  link.click();
  
  // 清除临时 URL
  URL.revokeObjectURL(url);
});
        
const uploadBtn = document.getElementById("upload-btn");
  const fileInput = document.getElementById('file-upload');
  fileInput.addEventListener('change', (event) => {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    cells = JSON.parse(reader.result);
    renderNotebook();
    // 处理jsonData
  };
  reader.readAsText(file);
});

const notebookEl = document.getElementById("notebook");
notebookEl.addEventListener("click", (event) => {
  const clickedCellEl = event.target.closest("[data-index]");
  if (clickedCellEl) {
    currentCellIndex = parseInt(clickedCellEl.getAttribute("data-index"));
  }
});

        

</script>
<style>
  body {
    background: #eee;
}    

  .input {
    width: 100%;
    height: auto;
    display: flow-root;
    border: 1px solid;
    border-radius: 4px;
    border-color: #999;
  }

  .output {
    margin-top: 10px;
    padding: 5px;
    background-color: lightgray;
    font-size: 12px;
    box-shadow: 0px 2px 2px #b9b1b1;
    font-family: monaco;
  }
    
  .CodeMirror {
    height: auto;
    min-height: 30px;
    display: block;
  }
 section {
    margin: 4vw;
    padding: 2vw;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0px 3px 3px #c8c8c8;
}
  .block {
    padding-bottom: 24px;
}
   .CodeMirror.cm-s-default {
    border-radius: 6px;
    font-size: 14px;
    background-color: #eee;
}
    .control {
    float: right;
    position: relative;
    transform: translate(0px, 12px);
    z-index: 100;
    background: #ddd;
    border-radius: 4px;
    padding: 2px;
    box-shadow: 0px 3px 3px #b9b1b1;
}
    button {
    border-style: none;
    background: #ddd;
    padding: 4px;
    border-radius: 4px;
    margin-left: 4px;
}
    button:hover {
    background: #eee;
}
    h2 {
    color: #666;
    padding-left: 40px;
}
    input[type=file] {
    display: none;
}
    label {
    border-style: none;
    background: #ddd;
    border-radius: 4px;
    margin-left: 4px;
    padding-inline: 2px;
    padding-bottom: 1px;
    position: relative;
    top: 1px;
}
    label:hover {
    background: #eee;
}
</style>
</body>
</html>
